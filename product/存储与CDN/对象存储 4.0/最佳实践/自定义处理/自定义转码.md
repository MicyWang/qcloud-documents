# **COS数据工作流+云函数最佳实践 - 自定义音视频转码**



音视频作为信息传播中流量占比最大的部分在各行业的业务中都弥足重要，而不同的业务场景中对音视频的处理逻辑可能具备行业的特殊性。

公有云虽然提供大量的视频处理服务供用户选择，但依然不能做到全面覆盖用户的特殊流程及定制化需求，使用 COS 工作流处理结合云函数定制逻辑此时就是一个绝佳选择，帮助用户快速创建满足需求的各种音视频处理服务。

​                 ![img](https://docimg7.docs.qq.com/image/2fx6EEU1GMbkYoDuEC0RpQ?w=1376&h=633)        

# **应用场景**

- 快速接入用户自建转码集群，兼容用户原有业务
- 支持行业特殊格式与处理逻辑，接入电影、安防等特殊行业
- 支持用户自定义处理逻辑，满足各场景下定制流程需求
- 触发工作流批量模板化处理，满足视频网站、教育、社交互联行业常见音视频处理需求

#  

# **方案优势**

- 加速开发：不再需要关注资源运维与组件开销，极大地降低了服务架构搭建的复杂性

- 降低开销：空闲时没有资源在运行，函数执行时按请求数和计算资源的运行时间收费，价格优势明显

- 高可用、高扩展：根据请求自动平行调整服务资源，拥有近乎无限的扩容能力，且免除单可用区运行的故障风险

  

# 操作步骤

1. 登录 [对象存储控制台](https://console.cloud.tencent.com/cos5)，创建工作流，自定义过滤规则，及创建自定义函数节点。详细操作请参见 [配置工作流](https://cloud.tencent.com/document/product/436/53967)。
   ![](https://main.qcloudimg.com/raw/9c14b9c44d885ec390c5ed259b8b1bff.png)    

2. 在函数节点弹窗里，点击新建函数，浏览器新标签会打开 SCF 的创建云函数的页面。

   <img src="https://main.qcloudimg.com/raw/f729eac94ec6d169835b039e17871a82.png" style="zoom:50%;" />

3. 创建云函数步驟

   - 选择“COS 数据工作流音视频转码”模板

   - 配置足够的内存、执行超时时间

   - 该函数模板支持五个环境变量

     *targetBucket 目标存储桶，必填*

     *targetRegion 目标存储桶地域，必填*

     *targetKeyTemplate 目标路径模板，可选，默认${InputPath}${InputName}_transcode.${ext}*

     *ffmpegTemplate 转码命令模板，必填，例如${ffmpeg} -loglevel error -i ${source} -r 10 -b:a 32k ${target}*

     *localTmpPath 临时保存路径，当绑定CFS时可以更改临时路径，可选，默认 /tmp*

   - 启用权限配置，绑定包含当前存储桶读权限和转码后存储桶写权限的角色，创建运行角色请看[文档](https://cloud.tencent.com/document/product/583/47933#.E5.88.9B.E5.BB.BA.E8.BF.90.E8.A1.8C.E8.A7.92.E8.89.B2)

   - 点击完成

     <img src="https://main.qcloudimg.com/raw/6523287666fc11aad2ad738e2eff66db.png" style="zoom:67%;" />

     <img src="https://main.qcloudimg.com/raw/3c99f228b6ba2c6585676049eee2470e.png" style="zoom:67%;" />

     如需新建运行角色，可以选择“云函数”作为角色载体，配置 QcloudCOSFullAccess 权限，或新建角色后自行绑定只包含所需储桶读权限的桶写权限。

     <img src="https://main.qcloudimg.com/raw/d5634d2849d924a1b6999fa920b636bd.png" style="zoom:67%;" />

   <img src="https://main.qcloudimg.com/raw/637f69d83cef81d8aa9ad9fe71c26b0e.png" style="zoom:67%;" />

4. 回到刚才创建工作流的页面，选中刚创建的自定义转码函数，并保存工作流，在工作流列表页开启工作流。

   <img src="https://main.qcloudimg.com/raw/a7482c537431697ac3aefbc5ad8b664f.png" style="zoom:67%;" />

5. 上传文件，查看工作流处理成功后，可以看到上传的视频已成功转码保存为新的文件。

   

   <img src="https://main.qcloudimg.com/raw/e8151001203541de02bbede682d6c4d0.png" style="zoom:67%;" />

   

   

   - 
